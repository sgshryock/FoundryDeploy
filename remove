#!/bin/bash
set -e

echo "=== Remove Foundry VTT Installation ==="
echo
echo "This will:"
echo "  - Stop and remove all Foundry containers"
echo "  - Remove deployment files (compose.yml, start, stop, logs, remove)"
echo
echo "You will be asked about:"
echo "  - Keeping or deleting Foundry VTT software and all your data"
echo "  - Keeping or removing nginx configuration and SSL certificates"
echo
echo "What will always be preserved:"
echo "  - The setup script (you can reinstall anytime)"
echo "  - Docker, git, nginx, and other dependencies"
echo
echo "What will be conditionally preserved:"
echo "  - Settings (.env) - kept if you keep data, deleted if you delete data"
echo
echo "Do you want to keep your Foundry installation and data?"
echo "This includes:"
echo "  - Foundry VTT software (so you don't have to redownload it)"
echo "  - All your worlds, modules, systems, and assets"
echo "  - Configuration and settings"
echo
read -p "Keep everything? [Y/n]: " keep_data
keep_data=${keep_data:-Y}

if [[ "$keep_data" =~ ^[Yy]$ ]]; then
    echo "[INFO] Foundry VTT software and data will be preserved in Docker volumes"
    echo "      Settings (.env) will also be preserved"
    echo "      Next time you run ./setup, it will use your existing installation and settings"
    remove_volumes=false
else
    echo
    echo "[WARN] This will PERMANENTLY DELETE:"
    echo "        - Foundry VTT software (will need to redownload on reinstall)"
    echo "        - ALL worlds, modules, systems, and assets"
    echo "        - ALL configuration and settings (in Foundry)"
    echo "        - Settings file (.env with credentials)"
    echo
    read -p "Are you absolutely sure? Type 'DELETE' to confirm: " confirm
    if [ "$confirm" != "DELETE" ]; then
        echo "Removal cancelled."
        exit 0
    fi
    remove_volumes=true
fi

echo

echo "Stopping containers..."
if docker compose ps --quiet 2>/dev/null | grep -q .; then
    if [ "$remove_volumes" = true ]; then
        docker compose down -v
        echo "[OK] Containers stopped and Docker volumes deleted"
        echo "     (Foundry VTT software and all data removed)"
    else
        docker compose down
        echo "[OK] Containers stopped"
        echo "     (Foundry VTT software and data preserved in Docker volumes)"
    fi
else
    echo "[INFO] No running containers found"
    if [ "$remove_volumes" = true ]; then
        echo "Removing Docker volumes..."
        docker compose down -v 2>/dev/null || true
        echo "[OK] Docker volumes deleted"
        echo "     (Foundry VTT software and all data removed)"
    fi
fi

# Ask about nginx configuration removal
echo
echo "nginx configuration includes:"
echo "  - Reverse proxy configuration (/etc/nginx/sites-available/foundry)"
echo "  - SSL certificates (/etc/nginx/certs/foundry.crt and foundry.key)"
echo
read -p "Remove nginx configuration and SSL certificates? [Y/n]: " remove_nginx
remove_nginx=${remove_nginx:-Y}

if [[ "$remove_nginx" =~ ^[Yy]$ ]]; then
    echo "Removing nginx configuration..."
    sudo rm -f /etc/nginx/sites-enabled/foundry
    sudo rm -f /etc/nginx/sites-available/foundry
    sudo rm -f /etc/nginx/certs/foundry.crt
    sudo rm -f /etc/nginx/certs/foundry.key

    # Reload nginx if it's running
    if systemctl is-active --quiet nginx 2>/dev/null; then
        sudo systemctl reload nginx 2>/dev/null || true
        echo "[OK] nginx configuration and SSL certificates removed (nginx reloaded)"
    else
        echo "[OK] nginx configuration and SSL certificates removed"
    fi
else
    echo "[INFO] nginx configuration kept"
    echo "      You can manually remove it later from /etc/nginx/sites-available/foundry"
fi

# Remove deployment files
echo
echo "Removing deployment files..."
rm -f compose.yml
rm -f start
rm -f stop
rm -f logs
rm -f .env.example

# Only remove .env if we're deleting data
# If keeping data, preserve .env so reinstall uses same settings
if [ "$remove_volumes" = true ]; then
    rm -f .env
    echo "[OK] Deployment files and settings removed (.env deleted)"
else
    echo "[OK] Deployment files removed (.env preserved for reinstall)"
fi

echo
echo "=== Removal Complete ==="
echo
echo "What was removed:"
echo "  - Foundry VTT containers"
if [ "$remove_volumes" = true ]; then
    echo "  - Deployment files (compose.yml, start, stop, logs, remove)"
    echo "  - Settings (.env with credentials and configuration)"
    echo "  - Foundry VTT software and all data (Docker volumes)"
else
    echo "  - Deployment files (compose.yml, start, stop, logs, remove)"
fi
echo
echo "What was preserved:"
echo "  - The setup script (./setup)"
if [ "$remove_volumes" = false ]; then
    echo "  - Settings (.env with credentials and configuration)"
    echo "  - Foundry VTT software and data (in Docker volumes)"
    echo "    Next installation will use your existing settings and Foundry"
fi
echo
if [ "$remove_volumes" = false ]; then
    echo "To restart Foundry VTT:"
    echo "  ./setup   - Reinstall and start (will use existing Foundry installation)"
else
    echo "To install Foundry VTT again:"
    echo "  ./setup   - Run setup (will download Foundry VTT fresh)"
fi
echo

# Remove this script last
rm -f "$0"
