#!/bin/bash
set -e

echo "=== Remove Foundry VTT Installation ==="
echo
echo "This will:"
echo "  - Stop all Foundry containers"
echo "  - Remove all containers and networks"
echo "  - Remove the FoundryDeploy directory"
echo "  - Optionally remove nginx configuration and SSL certificates"
echo
echo "This will NOT:"
echo "  - Remove Docker, git, nginx, or other dependencies"
echo "  - Remove the setup script"
echo
read -p "Do you want to keep your Foundry data (worlds, modules, etc.)? [Y/n]: " keep_data
keep_data=${keep_data:-Y}

if [[ "$keep_data" =~ ^[Yy]$ ]]; then
    echo "[INFO] Your Foundry data will be preserved in Docker volumes"
    remove_volumes=false
else
    echo "[WARN] Your Foundry data will be PERMANENTLY DELETED"
    read -p "Are you absolutely sure? Type 'DELETE' to confirm: " confirm
    if [ "$confirm" != "DELETE" ]; then
        echo "Removal cancelled."
        exit 0
    fi
    remove_volumes=true
fi

echo

# Get the parent directory (where we'll return to after deletion)
PARENT_DIR=$(dirname "$(pwd)")
INSTALL_DIR=$(basename "$(pwd)")

echo "Stopping containers..."
if docker compose ps --quiet 2>/dev/null | grep -q .; then
    docker compose down
    echo "[OK] Containers stopped and removed"
else
    echo "[INFO] No running containers found"
fi

if [ "$remove_volumes" = true ]; then
    echo "Removing data volumes..."
    docker compose down -v 2>/dev/null || true
    echo "[OK] Data volumes removed"
fi

# Ask about nginx configuration removal
echo
read -p "Do you want to remove nginx configuration and SSL certificates? [Y/n]: " remove_nginx
remove_nginx=${remove_nginx:-Y}

if [[ "$remove_nginx" =~ ^[Yy]$ ]]; then
    echo "Removing nginx configuration..."
    sudo rm -f /etc/nginx/sites-enabled/foundry
    sudo rm -f /etc/nginx/sites-available/foundry
    sudo rm -f /etc/nginx/certs/foundry.crt
    sudo rm -f /etc/nginx/certs/foundry.key

    # Reload nginx if it's running
    if systemctl is-active --quiet nginx 2>/dev/null; then
        sudo systemctl reload nginx 2>/dev/null || true
    fi

    echo "[OK] nginx configuration removed"
else
    echo "[INFO] nginx configuration kept (you can manually remove it later)"
fi

echo "Removing FoundryDeploy directory..."
cd "$PARENT_DIR"
rm -rf "$INSTALL_DIR"
echo "[OK] FoundryDeploy directory removed"

echo
echo "=== Removal Complete ==="
echo
if [ "$remove_volumes" = false ]; then
    echo "Your Foundry data is preserved in Docker volumes."
    echo "To remove it later, run: docker volume rm foundrydeploy_foundry_data"
fi
echo
echo "To reinstall, run the setup script again."
echo
