#!/bin/bash
set -e

echo "=== Remove Foundry VTT Installation ==="
echo
echo "This will:"
echo "  - Stop and remove all Foundry containers"
echo "  - Optionally remove Foundry data (worlds, modules, etc.)"
echo "  - Optionally remove nginx configuration and SSL certificates"
echo
echo "This will NOT:"
echo "  - Remove Docker, git, nginx, or other dependencies"
echo "  - Remove the FoundryDeploy directory or scripts"
echo
read -p "Do you want to keep your Foundry data (worlds, modules, etc.)? [Y/n]: " keep_data
keep_data=${keep_data:-Y}

if [[ "$keep_data" =~ ^[Yy]$ ]]; then
    echo "[INFO] Your Foundry data will be preserved in Docker volumes"
    remove_volumes=false
else
    echo "[WARN] Your Foundry data will be PERMANENTLY DELETED"
    read -p "Are you absolutely sure? Type 'DELETE' to confirm: " confirm
    if [ "$confirm" != "DELETE" ]; then
        echo "Removal cancelled."
        exit 0
    fi
    remove_volumes=true
fi

echo

# Get the parent directory (where we'll return to after deletion)
PARENT_DIR=$(dirname "$(pwd)")
INSTALL_DIR=$(basename "$(pwd)")

echo "Stopping containers..."
if docker compose ps --quiet 2>/dev/null | grep -q .; then
    if [ "$remove_volumes" = true ]; then
        docker compose down -v
        echo "[OK] Containers stopped and data volumes removed"
    else
        docker compose down
        echo "[OK] Containers stopped (data preserved in volumes)"
    fi
else
    echo "[INFO] No running containers found"
    if [ "$remove_volumes" = true ]; then
        echo "Removing data volumes..."
        docker compose down -v 2>/dev/null || true
        echo "[OK] Data volumes removed"
    fi
fi

# Ask about nginx configuration removal
echo
read -p "Do you want to remove nginx configuration and SSL certificates? [Y/n]: " remove_nginx
remove_nginx=${remove_nginx:-Y}

if [[ "$remove_nginx" =~ ^[Yy]$ ]]; then
    echo "Removing nginx configuration..."
    sudo rm -f /etc/nginx/sites-enabled/foundry
    sudo rm -f /etc/nginx/sites-available/foundry
    sudo rm -f /etc/nginx/certs/foundry.crt
    sudo rm -f /etc/nginx/certs/foundry.key

    # Reload nginx if it's running
    if systemctl is-active --quiet nginx 2>/dev/null; then
        sudo systemctl reload nginx 2>/dev/null || true
    fi

    echo "[OK] nginx configuration removed"
else
    echo "[INFO] nginx configuration kept (you can manually remove it later)"
fi

echo
echo "=== Removal Complete ==="
echo
echo "FoundryDeploy directory and scripts have been preserved."
if [ "$remove_volumes" = false ]; then
    echo "Your Foundry data is preserved in Docker volumes."
fi
echo
echo "To reinstall or restart:"
echo "  ./setup   - Reconfigure and start"
echo "  ./start   - Just start containers (if already configured)"
echo
