#!/bin/bash
set -e

echo "=== Starting Foundry VTT ==="
echo

# Check for docker
if ! command -v docker &> /dev/null; then
    echo "[ERROR] Docker is not installed"
    exit 1
fi

# Check if docker daemon is running
if ! docker info &> /dev/null; then
    echo "[ERROR] Docker daemon is not running"
    echo "  Start it with: sudo systemctl start docker"
    exit 1
fi

# Check for docker compose
if ! docker compose version &> /dev/null; then
    if ! command -v docker-compose &> /dev/null; then
        echo "[ERROR] Docker Compose is not installed"
        exit 1
    fi
fi

# Check for .env file
if [ ! -f .env ]; then
    echo "[ERROR] No .env file found. Run ./setup first or copy .env.example to .env"
    exit 1
fi

# Function to parse .env values robustly
parse_env_value() {
    local key=$1
    grep -E "^${key}=" .env | cut -d'=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/#.*//'
}

# Start nginx
echo "Starting nginx..."
if sudo systemctl start nginx 2>/dev/null; then
    echo "[OK] nginx started"
else
    echo "[WARN] Could not start nginx (may already be running)"
fi

echo "Starting containers..."
docker compose up -d

echo
echo "Waiting for containers to start..."

# Poll for container readiness (max 30 seconds)
max_wait=30
waited=0
while [ $waited -lt $max_wait ]; do
    if docker compose ps 2>/dev/null | grep -q "foundry.*Up"; then
        echo
        echo "[OK] Foundry container is ready"
        break
    fi
    echo -n "."
    sleep 1
    waited=$((waited + 1))
done

if [ $waited -ge $max_wait ]; then
    echo
    echo "[WARN] Foundry may still be starting (waited ${max_wait}s)"
    echo "  Check status with: docker compose ps"
fi

# Check container status
echo
echo "Checking services..."

if docker compose ps | grep -q "foundry.*Up"; then
    echo "[OK] Foundry container is running"

    # Check for authentication failures in logs
    echo "Checking for authentication errors..."
    sleep 3  # Give container time to attempt authentication

    if docker compose logs foundry --tail 50 2>/dev/null | grep -q "Unable to authenticate\|Unable to log in"; then
        echo
        echo "[ERROR] Foundry authentication failed"
        echo "        Your Foundry credentials in .env are incorrect"
        echo
        echo "To fix:"
        echo "  1. Verify your credentials at https://foundryvtt.com"
        echo "  2. Run ./setup to update your credentials"
        echo "  3. Run ./start to try again"
        echo
        echo "Current username: $(parse_env_value 'FOUNDRY_USERNAME')"
        exit 1
    fi

    # Check if container is restarting (crash loop)
    if docker compose ps | grep -q "foundry.*Restarting"; then
        echo
        echo "[ERROR] Foundry container is crash-looping"
        echo "        Check logs for details: ./logs"
        exit 1
    fi

elif docker compose ps | grep -q "foundry.*Restarting"; then
    echo "[ERROR] Foundry container is restarting (likely crashed)"
    echo
    # Check for common errors
    if docker compose logs foundry --tail 50 2>/dev/null | grep -q "Unable to authenticate\|Unable to log in"; then
        echo "[ERROR] Authentication failed - your Foundry credentials are incorrect"
        echo
        echo "To fix:"
        echo "  1. Verify your credentials at https://foundryvtt.com"
        echo "  2. Run ./setup to update your credentials"
        echo "  3. Run ./start to try again"
        echo
        echo "Current username: $(parse_env_value 'FOUNDRY_USERNAME')"
    else
        echo "Check logs with: ./logs"
    fi
    exit 1
else
    echo "[ERROR] Foundry container is not running"
    echo "  Check logs with: docker compose logs foundry"
    exit 1
fi

if systemctl is-active --quiet nginx; then
    echo "[OK] nginx is running"
else
    echo "[ERROR] nginx is not running"
    echo "  Start it with: sudo systemctl start nginx"
    exit 1
fi

echo
echo "=== Foundry VTT Started ==="
echo
FOUNDRY_HOSTNAME=$(parse_env_value "FOUNDRY_HOSTNAME")
echo "Access Foundry at: https://${FOUNDRY_HOSTNAME}"
echo
echo "View logs with:"
echo "  ./logs"
echo
