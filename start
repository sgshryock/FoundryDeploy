#!/bin/bash
set -e

echo "=== Starting Foundry VTT ==="
echo

# Check for docker
if ! command -v docker &> /dev/null; then
    echo "[ERROR] Docker is not installed"
    exit 1
fi

# Check if docker daemon is running
if ! docker info &> /dev/null; then
    echo "[ERROR] Docker daemon is not running"
    echo "  Start it with: sudo systemctl start docker"
    exit 1
fi

# Check for docker compose
if ! docker compose version &> /dev/null; then
    if ! command -v docker-compose &> /dev/null; then
        echo "[ERROR] Docker Compose is not installed"
        exit 1
    fi
fi

# Check for .env file
if [ ! -f .env ]; then
    echo "[ERROR] No .env file found. Run ./setup first or copy .env.example to .env"
    exit 1
fi

# Function to parse .env values robustly
parse_env_value() {
    local key=$1
    grep -E "^${key}=" .env | cut -d'=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/#.*//'
}

# Load port from .env
FOUNDRY_PORT=$(parse_env_value "FOUNDRY_PORT")
FOUNDRY_PORT=${FOUNDRY_PORT:-80}

echo "Starting containers..."
docker compose up -d

echo
echo "Waiting for containers to start..."

# Poll for container readiness (max 30 seconds)
max_wait=30
waited=0
while [ $waited -lt $max_wait ]; do
    if docker compose ps 2>/dev/null | grep -q "foundry.*Up" && docker compose ps 2>/dev/null | grep -q "caddy.*Up"; then
        echo
        echo "[OK] Containers are ready"
        break
    fi
    echo -n "."
    sleep 1
    waited=$((waited + 1))
done

if [ $waited -ge $max_wait ]; then
    echo
    echo "[WARN] Containers may still be starting (waited ${max_wait}s)"
    echo "  Check status with: docker compose ps"
fi

# Check container status
echo
echo "Checking container status..."

if docker compose ps | grep -q "foundry.*Up"; then
    echo "[OK] Foundry container is running"
else
    echo "[ERROR] Foundry container is not running"
    echo "  Check logs with: docker compose logs foundry"
    exit 1
fi

if docker compose ps | grep -q "caddy.*Up"; then
    echo "[OK] Caddy container is running"
else
    echo "[ERROR] Caddy container is not running"
    echo "  Check logs with: docker compose logs caddy"
    exit 1
fi

# Check if port is listening (supports IPv4 and IPv6)
if docker compose ps | grep -E -q "(0\.0\.0\.0|:::|:)${FOUNDRY_PORT}->80"; then
    echo "[OK] Caddy is listening on port ${FOUNDRY_PORT}"
else
    echo "[WARN] Could not verify port ${FOUNDRY_PORT} is exposed"
fi

echo
echo "=== Foundry VTT Started ==="
echo
FOUNDRY_HOSTNAME=$(parse_env_value "FOUNDRY_HOSTNAME")
echo "Access Foundry at: http://${FOUNDRY_HOSTNAME}:${FOUNDRY_PORT}"
echo
echo "View logs with:"
echo "  docker compose logs -f"
echo
